# use this if our build script changes and we need to increment beyond intel's version
# this variable defines oneMKL specific version
# this variable defines oneMKL specific buildnum
# this variable defines openmp specific version
# this variable defines openmp specific buildnum
package:
  name: intel_repack
  version: "2025.0.0"

source:
  - url: https://software.repos.intel.com/python/conda/linux-64/mkl-2025.0.0-intel_939.tar.bz2
    folder: mkl
    sha256: 08018b7b73b8f1ceb2286d0fbf443bcf22ffd5fdff2010265f3cedbd0c3075d6
  - url: https://software.repos.intel.com/python/conda/linux-64/mkl-devel-2025.0.0-intel_939.tar.bz2
    folder: mkl-devel
    sha256: 89fc99f696ee10291b39bd60f6104966ba07f750e4291830d3ed142e651ef0c3
  - url: https://software.repos.intel.com/python/conda/linux-64/mkl-include-2025.0.0-intel_939.tar.bz2
    folder: mkl-include
    sha256: e3c02344b0405d90c7b992493a081f1f763fa96493626a5da1fe7693040a486f
  - url: https://software.repos.intel.com/python/conda/linux-64/intel-openmp-2025.0.0-intel_1169.tar.bz2
    folder: intel-openmp
    sha256: bd2ef2fdac3e013bfdf71921e0c7d3e831b9f498d6303852539b2c447bd42790

build:
  number: 941
  binary_relocation: false
  detect_binary_files_with_prefix: false

outputs:
  - name: mkl
    version: "2025.0.0"
    script: repack.sh
    build:
      number: 941
      ignore_run_exports:
      missing_dso_whitelist:
        # tbb
        - $RPATH/libtbb.so.12
        # oneAPI ?
        # PGI tools?
    requirements:
      build:
        - {{ compiler('c') }}
        - {{ compiler('cxx') }}
      run:
        - intel-openmp 2025.*
        - tbb-devel 2022.*
    about:
      home: https://www.intel.com/content/www/us/en/developer/tools/oneapi/onemkl.html
      license: LicenseRef-IntelSimplifiedSoftwareOct2022
      license_family: Proprietary
      license_file:
        - mkl/info/licenses/license.txt
        - mkl/info/licenses/tpp.txt
      summary: Intel® oneAPI Math Kernel Library runtime libraries
      description: |
        Intel® oneAPI Math Kernel Library is Intel®-Optimized Math Library for Numerical Computing on CPUs & GPUs
        This package is a repackaged set of binaries obtained directly from Intel\'s anaconda.org channel.
      doc_url: https://www.intel.com/content/www/us/en/developer/tools/oneapi/onemkl.html
    test:
      commands:
        - ls -A $PREFIX/lib/*
        - test -f $PREFIX/lib/libmkl_core${SHLIB_EXT}
        - test -f $PREFIX/lib/libmkl_rt${SHLIB_EXT}
  - name: mkl-include
    version: "2025.0.0"
    script: repack.sh
    number: 941
    # An empty requirements/build to satisfy anaconda-linter.
    requirements:
      build:
    about:
      home: https://www.intel.com/content/www/us/en/developer/tools/oneapi/onemkl.html
      license: LicenseRef-IntelSimplifiedSoftwareOct2022
      license_family: Proprietary
      license_file:
        - mkl-include/info/licenses/license.txt
        - mkl-include/info/licenses/tpp.txt
      summary: Headers for building against Intel® oneMKL libraries
      description: |
        Intel® oneAPI Math Kernel Library headers for developing software that uses oneMKL
        This package is a repackaged set of binaries obtained directly from Intel\'s anaconda.org channel.
      doc_url: https://www.intel.com/content/www/us/en/developer/tools/oneapi/onemkl.html
    test:
      commands:
        - ls -A $PREFIX/include/*
        - test -f $PREFIX/include/mkl.h
        - test -f $PREFIX/include/mkl_blas.h
        - test -f $PREFIX/include/mkl_cblas.h
        - test -f $PREFIX/include/mkl_df.h
        - test -f $PREFIX/include/mkl_lapack.h
        - test -f $PREFIX/include/mkl_service.h
        - test -f $PREFIX/include/mkl_solvers_ee.h
        - test -f $PREFIX/include/mkl_trans.h
        - test -f $PREFIX/include/mkl_types.h
        - test -f $PREFIX/include/mkl_version.h
  - name: mkl-devel
    version: "2025.0.0"
    script: install-devel.sh
    number: 941
    build:
      run_exports:
        - {{ pin_subpackage('mkl') }}
        - blas=*=mkl
        # this was added to prior mkl-devel releases but not in the feedstock. This is used by
        # various downstreams (mkl_fft, mkl_random) to include the mkl-service wrapper as a dependency.
        - mkl-service >=2.3.0,<3.0a0
    requirements:
      run:
        - {{ pin_subpackage('mkl', exact=True) }}
        - {{ pin_subpackage('mkl-include', exact=True) }}
        - blas * mkl
    about:
      home: https://www.intel.com/content/www/us/en/developer/tools/oneapi/onemkl.html
      summary: Devel package for building against Intel® oneMKL libraries
      description: |
        Intel® oneAPI Math Kernel Library headers and libraries for developing software that uses oneMKL
        This package is a repackaged set of binaries obtained directly from Intel\'s anaconda.org channel.
      license: LicenseRef-IntelSimplifiedSoftwareOct2022
      license_family: Proprietary
      license_file:
        - mkl-devel/info/licenses/license.txt
        - mkl-devel/info/licenses/tpp.txt
    test:
      requires:
        - {{ compiler('c') }}
        - cmake
        - ninja
        - pkg-config
      files:
        - tests
      commands:
        - test -f $PREFIX/lib/pkgconfig/mkl-sdl.pc
        # Verify that the mkl library can be located through pkg-config
        - test -f `pkg-config --variable=libdir --dont-define-prefix mkl-sdl`/libmkl_rt${SHLIB_EXT}
        - cmake -S tests/mkl-devel -B build -G Ninja -DCMAKE_VERBOSE_MAKEFILE=ON
        - cmake --build build -v
        - ./build/myapp
  - name: intel-openmp
    script: repack.sh
    version: "2025.0.0"
    build:
      number: 1171
      missing_dso_whitelist:
        # OS specific:
        - /lib64/libelf.so.1  # - OS file.
        - /lib64/libgcc_s.so.1
        - /lib64/libc.so.6
        - /lib64/libstdc++.so.6
        - /lib64/ld-linux-x86-64.so.2
        - /lib64/libdl.so.2
        - /lib64/librt.so.1
        - /lib64/libm.so.6
        - /lib64/libz.so.1
        - /lib64/libpthread.so.0
        - $RPATH/libffi.so
        # Optional intel-cmplr-lib-rt
        - $RPATH/libimf.so  # - intel-cmplr-lib-rt.
        - $RPATH/libintlc.so.5  # - intel-cmplr-lib-rt.
        - $RPATH/libirng.so  # - intel-cmplr-lib-rt.
        - $RPATH/libsvml.so  # - intel-cmplr-lib-rt.
        # Optional `intel-opencl-rt`:
        - $RPATH/libOpenCL.so.1  # - optional `intel-opencl-rt`.
        # Optional oneAPI loaders:
        - $RPATH/libur_loader.so.0  # - optional oneAPI Unified Runtime loader.
        - $RPATH/libze_loader.so.1  # - optional oneAPI Level Zero loader.
        # Optional dpcpp_cpp_rt
        - $RPATH/libsycl.so.8
      host:
        - intel-cmplr-lib-ur 2025.*
      run_constrained:
        # prevent clobbering if user tries to install llvm's implementation
        # TODO: use intel mutex or build windows torch in conda-froge
        # https://github.com/conda-forge/intel-graphics-compiler-feedstock/pull/59
        - llvm-openmp <0a0
        - __glibc >=2.26  # - intel-openmp 2025.0.0 and newer is built with a newer GLIBC
    # An empty requirements/build to satisfy anaconda-linter.
    requirements:
      build:
    about:
      home: https://www.intel.com/content/www/us/en/developer/tools/overview.html
      license: LicenseRef-IntelSimplifiedSoftwareOct2022
      license_family: Proprietary
      license_file:
        - intel-openmp/info/licenses/license.txt
        - intel-openmp/info/licenses/tpp.txt
      summary: Intel® oneAPI Compiler OpenMP runtime
      description: |
        Intel® oneAPI Compiler OpenMP runtime implementation
        This package is a repackaged set of binaries obtained directly from Intel\'s anaconda.org channel.
      doc_url: https://www.intel.com/content/www/us/en/developer/tools/overview.html
    test:
      commands:
        - ls -A $PREFIX/lib/*
        - test -f $PREFIX/lib/libiomp5${SHLIB_EXT}
        - test -f $PREFIX/lib/libomptarget${SHLIB_EXT}
  # mutex package to keep only one blas implementation in a given env
  # Since this package has a non-unique name, blas-1.0-mkl.conda, it is omitted from future updates as they cause issues
  # with overwrites on the PBP. If an update to this package is needed in the future, the name should have a hash added
  # so that it becomes unique per publish.

#  - name: blas
#    version: 1.0
#    build:
#      string: mkl
#    # An empty requirements/build to satisfy anaconda-linter.
#    requirements:
#      build:
#    test:
#      commands:
#        - echo 'works!'
#    about:
#      home: https://github.com/conda-forge/intel_repack-feedstock
#      license: BSD-3-Clause
#      license_file: ANACONDA_LICENSE
#      summary: 'BLAS mutex for MKL'
# please the linter
about:
  home: https://github.com/conda-forge/intel_repack-feedstock
  license: LicenseRef-IntelSimplifiedSoftwareOct2022
  license_url: https://www.intel.com/content/www/us/en/content-details/749362/intel-simplified-software-license-version-october-2022.html
  license_family: Proprietary
  summary: Repackaged Intel libraries
  description: Repackaging of Intel's MKL packages for usage in Anaconda
  doc_url: https://github.com/AnacondaRecipes/intel_repack-feedstock/blob/master/README.md
  dev_url: https://github.com/AnacondaRecipes/intel_repack-feedstock

extra:
  skip-lints:
    - cbc_dep_in_run_missing_from_host
  recipe-maintainers:
    - isuruf
    - beckermr
    - napetrov
    - oleksandr-pavlyk
    - alexsandruss
    - ZzEeKkAa
